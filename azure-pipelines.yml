trigger:
  branches:
    include: [ main ]

variables:
  location: 'eastus'
  project_rg: 'rg-healthcare-demo'
  tag_environment: 'Dev'
  tag_owner: 'Savannah Fry'
  tag_costcenter: 'PORTFOLIO'

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self

# Install Terraform without marketplace dependencies
- task: AzureCLI@2
  displayName: 'Install Terraform 1.7.5'
  inputs:
    azureSubscription: 'sc-azure-portfolio'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euxo pipefail
      if ! command -v terraform >/dev/null 2>&1; then
        sudo apt-get update -y
        sudo apt-get install -y unzip curl
        curl -sSLo /tmp/terraform.zip https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
        sudo unzip -o /tmp/terraform.zip -d /usr/local/bin
      fi
      terraform -version

# Init/Validate/Plan (LOCAL state)
- task: AzureCLI@2
  displayName: 'Terraform init/validate/plan (local)'
  inputs:
    azureSubscription: 'sc-azure-portfolio'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euxo pipefail
      cd infra
      terraform fmt -recursive
      terraform init -input=false
      terraform validate
      terraform plan -out=tfplan \
        -var "location=$(location)" \
        -var "project_rg=$(project_rg)" \
        -var "tag_environment=$(tag_environment)" \
        -var "tag_owner=$(tag_owner)" \
        -var "tag_costcenter=$(tag_costcenter)"

# Apply
- task: AzureCLI@2
  displayName: 'Terraform apply (local)'
  inputs:
    azureSubscription: 'sc-azure-portfolio'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euxo pipefail
      cd infra
      terraform apply -auto-approve tfplan
