trigger:
  branches:
    include:
      - main

variables:
  location: 'eastus'
  tf_state_rg: 'rg-tfstate-health-demo'
  tf_state_sa: 'tfstatehealthdemo'            # <= must be 3-24 lowercase letters/numbers only, globally unique
  tf_state_container: 'tfstate'               # <= container name
  project_rg: 'rg-health-demo'
  app_name: 'func-health-1234567'             # <= must be globally unique
  enable_networking: 'true'
  tag_environment: 'Dev'
  tag_owner: 'Savannah Fry'
  tag_costcenter: 'HCARE-POC'
  governance_mode: 'audit'

stages:
# ------------------ PLAN ------------------
- stage: Terraform_Plan
  displayName: 'Terraform: validate & plan'
  jobs:
  - job: plan
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: 'Install Terraform 1.7.5'
      inputs:
        azureSubscription: 'sc-azure-portfolio'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y unzip curl
          curl -sSLo /tmp/terraform.zip https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
          sudo unzip -o /tmp/terraform.zip -d /usr/local/bin
          terraform -version

    - task: AzureCLI@2
      displayName: 'Ensure backend RG/SA/container exist'
      inputs:
        azureSubscription: 'sc-azure-portfolio'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euxo pipefail
          az group create -n "$(tf_state_rg)" -l "$(location)"
          if ! az storage account show -g "$(tf_state_rg)" -n "$(tf_state_sa)" >/dev/null 2>&1; then
            az storage account create -g "$(tf_state_rg)" -n "$(tf_state_sa)" -l "$(location)" --sku Standard_LRS --encryption-services blob
          fi
          az storage container create --name "$(tf_state_container)" --account-name "$(tf_state_sa)" --auth-mode login >/dev/null

    - task: AzureCLI@2
      displayName: 'Terraform init/validate/plan'
      inputs:
        azureSubscription: 'sc-azure-portfolio'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euxo pipefail
          cd infra

          # write a clean backend.tf (only backend & required providers)
          cat > backend.tf <<'EOF'
          terraform {
            required_version = ">= 1.6"
            required_providers {
              azurerm = {
                source  = "hashicorp/azurerm"
                version = "~> 3.0"
              }
            }
            backend "azurerm" {}
          }
          provider "azurerm" { features {} }
          EOF

          terraform fmt -recursive
          terraform init \
            -backend-config="resource_group_name=$(tf_state_rg)" \
            -backend-config="storage_account_name=$(tf_state_sa)" \
            -backend-config="container_name=$(tf_state_container)" \
            -backend-config="key=$(app_name).tfstate"

          terraform validate

          terraform plan -out tfplan \
            -var "location=$(location)" \
            -var "project_rg=$(project_rg)" \
            -var "app_name=$(app_name)" \
            -var "enable_networking=$(enable_networking)" \
            -var "tag_environment=$(tag_environment)" \
            -var "tag_owner=$(tag_owner)" \
            -var "tag_costcenter=$(tag_costcenter)" \
            -var "governance_mode=$(governance_mode)"

          # move plan to staging for artifact publish
          mkdir -p "$(Build.ArtifactStagingDirectory)"
          cp tfplan "$(Build.ArtifactStagingDirectory)/tfplan"

    - task: PublishBuildArtifacts@1
      displayName: 'Publish plan artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'plan'

# ------------------ APPLY ------------------
- stage: Terraform_Apply
  displayName: 'Terraform: apply with approval'
  dependsOn: Terraform_Plan
  jobs:
  - deployment: apply
    environment: 'manual-approval'   # create once; gate this env with approval in DevOps
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'plan'
              downloadPath: '$(Pipeline.Workspace)'

          - task: AzureCLI@2
            displayName: 'Terraform apply'
            inputs:
              azureSubscription: 'sc-azure-portfolio'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euxo pipefail
                cd infra
                # backend must match exactly as in plan stage
                cat > backend.tf <<'EOF'
                terraform {
                  required_version = ">= 1.6"
                  required_providers {
                    azurerm = {
                      source  = "hashicorp/azurerm"
                      version = "~> 3.0"
                    }
                  }
                  backend "azurerm" {}
                }
                provider "azurerm" { features {} }
                EOF

                terraform init \
                  -backend-config="resource_group_name=$(tf_state_rg)" \
                  -backend-config="storage_account_name=$(tf_state_sa)" \
                  -backend-config="container_name=$(tf_state_container)" \
                  -backend-config="key=$(app_name).tfstate"

                terraform apply -auto-approve "$(Pipeline.Workspace)/plan/tfplan"

# ------------------ DEPLOY FUNCTION ------------------
- stage: Build_And_Deploy_Function
  displayName: 'Zip & Deploy Azure Function'
  dependsOn: Terraform_Apply
  jobs:
  - job: deploy
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - task: ArchiveFiles@2
      displayName: 'Zip function app'
      inputs:
        rootFolderOrFile: 'app'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish app.zip'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/app.zip'
        ArtifactName: 'drop'

    - task: AzureCLI@2
      displayName: 'Zip deploy to Function App'
      inputs:
        azureSubscription: 'sc-azure-portfolio'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euxo pipefail
          az functionapp deployment source config-zip \
            --resource-group "$(project_rg)" \
            --name "$(app_name)" \
            --src "$(Build.ArtifactStagingDirectory)/app.zip"
